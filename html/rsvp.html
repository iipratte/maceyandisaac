<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>RSVP | Macey & Isaac</title>
		<link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
		<link rel="stylesheet" href="../styles/rsvp.css" />
		<link rel="icon" type="image/x-icon" href="../favicon.png" />
	</head>
	<body>
		<nav>
			<a href="../index.html">Home</a>
			<a href="ourstory.html">Our Story</a>
			<a href="#" class="active">RSVP</a>
			<a href="#">Photos</a>
			<a href="https://www.amazon.com/hz/wishlist/ls/2C523YDBJEFOI?ref=cm_sw_em_r_un_un_XYK5Imj1GsleZ" target="_blank">Registry</a>
		</nav>

		<section class="rsvp-container">
			<h1>RSVP</h1>
			<hr />

			<p>Please enter your full name to view your invitation details:</p>

			<div class="form-group">
				<input type="text" id="firstName" placeholder="First Name" required />
				<input type="text" id="lastName" placeholder="Last Name" required />
				<button onclick="lookupGuest()">Lookup</button>
			</div>

			<div id="results"></div>
		</section>

		<script>
			const scriptURL = "https://script.google.com/macros/s/AKfycbxpkNOTghFOIE2WS0VmTIMVlbh0nXrx0pGCfCeUgArcA4E0C42NMsdQYdDvH0n2Iw-o1A/exec";
			let currentGuest = null;

			async function lookupGuest() {
				const firstName = document.getElementById("firstName").value.trim();
				const lastName = document.getElementById("lastName").value.trim();
				const results = document.getElementById("results");

				if (!firstName || !lastName) {
					results.innerHTML = "<p class='error'>Please enter both first and last name.</p>";
					return;
				}

				results.innerHTML = "<p>Searching...</p>";

				try {
					const response = await fetch(`${scriptURL}?action=lookup&first=${encodeURIComponent(firstName)}&last=${encodeURIComponent(lastName)}`);
					const data = await response.json();

					if (!data.found) {
						results.innerHTML = "<p class='error'>Name not found. Please double-check your entry.</p>";
						return;
					}

					// Store guest data for submission
					currentGuest = {
						guest_id: data.guest_id,
						display_name: data.display_name,
						name_entered: `${firstName} ${lastName}`,
					};

					let html = `<h2>Welcome, ${data.display_name}!</h2><p>Please RSVP for the following events:</p><form id="rsvpForm" onsubmit="submitRSVP(event)">`;

					if (data.ceremony_invite)
						html += `<label>Ceremony: </label><select name="ceremony" required><option value="">Select...</option><option value="Yes">Yes</option><option value="No">No</option></select><br><br>`;

					if (data.reception_invite)
						html += `<label>Reception: </label><select name="reception" required><option value="">Select...</option><option value="Yes">Yes</option><option value="No">No</option></select><br><br>`;

					if (data.california_open_house_invite)
						html += `<label>California Open House: </label><select name="california" required><option value="">Select...</option><option value="Yes">Yes</option><option value="No">No</option></select><br><br>`;

					html += `
			<label>Bringing a plus one?</label>
			<select id="plusOne" name="plusOne" onchange="togglePlusOneName(this)">
				<option value="No">No</option>
				<option value="Yes">Yes</option>
			</select>
			<div id="plusOneName" style="display:none; margin-top:10px;">
				<input type="text" placeholder="Plus One Name" name="plusOneName">
			</div>
			<br><br>
			<label>Comments (optional):</label>
			<textarea name="comments" rows="3" style="width:100%; margin-top:5px;"></textarea>
			<br><br>
			<button type="submit">Submit RSVP</button>
		</form>`;

					results.innerHTML = html;
				} catch (err) {
					console.error(err);
					results.innerHTML = "<p class='error'>Error connecting to server. Try again later.</p>";
				}
			}

			async function submitRSVP(event) {
				event.preventDefault();

				const form = event.target;
				const formData = new FormData(form);
				const results = document.getElementById("results");

				// Build submission URL
				let submitURL = `${scriptURL}?action=submit`;
				submitURL += `&guest_id=${encodeURIComponent(currentGuest.guest_id)}`;
				submitURL += `&name_entered=${encodeURIComponent(currentGuest.name_entered)}`;
				submitURL += `&ceremony_response=${encodeURIComponent(formData.get("ceremony") || "N/A")}`;
				submitURL += `&reception_response=${encodeURIComponent(formData.get("reception") || "N/A")}`;
				submitURL += `&california_response=${encodeURIComponent(formData.get("california") || "N/A")}`;
				submitURL += `&bringing_plus_one=${encodeURIComponent(formData.get("plusOne") || "No")}`;
				submitURL += `&plus_one_name=${encodeURIComponent(formData.get("plusOneName") || "")}`;
				submitURL += `&comments=${encodeURIComponent(formData.get("comments") || "")}`;

				results.innerHTML = "<p>Submitting your RSVP...</p>";

				try {
					const response = await fetch(submitURL);
					const data = await response.json();

					if (data.success) {
						results.innerHTML = `<div style="text-align:center; padding:20px;"><h2>âœ“ Thank You!</h2><p>Your RSVP has been submitted successfully.</p><p>We look forward to celebrating with you!</p></div>`;
					} else {
						results.innerHTML = "<p class='error'>There was an issue submitting your RSVP. Please try again.</p>";
					}
				} catch (err) {
					console.error(err);
					results.innerHTML = "<p class='error'>Error submitting RSVP. Please try again later.</p>";
				}
			}

			function togglePlusOneName(select) {
				document.getElementById("plusOneName").style.display = select.value === "Yes" ? "block" : "none";
			}
		</script>
	</body>
</html>
